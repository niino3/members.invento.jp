# 開発フェーズ詳細

## フェーズ1: 開発環境構築とプロジェクト初期設定

### 作業内容
1. **Next.jsプロジェクトの作成**
   - TypeScript対応
   - App Router使用
   - Tailwind CSS導入
   - プロジェクト名: members.invento.jp

2. **プロジェクト構造の整備**
   ```
   /
   ├── app/              # App Router用ディレクトリ
   ├── components/       # 共通コンポーネント
   ├── lib/             # ユーティリティ関数
   ├── types/           # TypeScript型定義
   ├── public/          # 静的ファイル
   └── docs/            # ドキュメント
   ```

3. **必要なパッケージのインストール**
   - Firebase SDK
   - Firebase Admin SDK
   - その他必要なライブラリ

4. **環境変数の設定**
   - .env.localファイルの作成
   - Firebase設定用の環境変数定義

5. **Firebaseプロジェクトの準備**
   - Firebaseコンソールでプロジェクト作成
   - 必要なサービスの有効化

6. **基本的なスタイル設定**
   - Tailwind CSSのカスタマイズ
   - 共通スタイルの定義

## フェーズ2: 認証基盤

### 作業内容
1. **Firebase Authentication統合**
   - Firebase設定ファイルの作成
   - 認証用のSDK初期化

2. **認証管理システム**
   - AuthContextの実装（認証状態管理）
   - useAuthカスタムフックの作成
   - 認証状態の永続化

3. **認証画面の実装**
   - ログインページ
   - サインアップページ
   - パスワードリセットページ

4. **認証保護機能**
   - middlewareによるルート保護
   - 未認証ユーザーのリダイレクト
   - ロール別アクセス制御（管理者/ユーザー）

## フェーズ3: データベース設計とFirestore統合

### 作業内容
1. **データベース設計**
   - コレクション構造の定義
   - ドキュメントスキーマの設計
   - リレーションシップの定義

2. **TypeScript型定義**
   - 顧客データ型
   - サービスデータ型
   - 請求データ型
   - その他必要な型

3. **データアクセス層**
   - CRUD操作関数の実装
   - クエリ関数の実装
   - データ変換ユーティリティ

4. **セキュリティルール**
   - Firestore Security Rules設定
   - 読み取り/書き込み権限の定義

## フェーズ4: 管理者向け顧客管理機能

### 作業内容
1. **管理者用UI基盤**
   - 管理者レイアウト
   - ナビゲーションメニュー
   - 共通UIコンポーネント

2. **顧客管理機能**
   - 顧客一覧表示（テーブル形式）
   - 顧客検索・フィルター機能
   - ページネーション
   - 顧客編集機能（既存顧客情報の更新）
   - 顧客解約機能（確認ダイアログ付き）

3. **顧客詳細機能**
   - 顧客情報の詳細表示
   - 全フィールドの表示対応

4. **顧客編集機能**
   - 新規登録フォーム
   - 編集フォーム
   - フォームバリデーション
   - 削除機能（確認付き）

## フェーズ5: 管理者向けサービス管理機能

### 作業内容
1. **サービスカテゴリー管理**
   - サービスカテゴリー型定義の作成
   - サービスカテゴリーFirestore関数の実装
   - サービスカテゴリー一覧表示
   - サービスカテゴリー検索機能
   - サービスカテゴリーCRUD機能（新規作成、編集、削除）

2. **サービス管理画面（カテゴリー対応）**
   - サービス型にcategoryId追加
   - サービス一覧表示（カテゴリー別表示）
   - サービス検索機能
   - カテゴリー別フィルター機能

3. **サービスCRUD機能（カテゴリー対応）**
   - サービス新規作成（カテゴリー選択必須）
   - サービス編集（カテゴリー変更可能）
   - サービス削除

4. **顧客とサービスの連携**
   - 顧客へのサービス割り当て（カテゴリー別表示）
   - 複数サービス対応
   - サービス利用状況の表示

## フェーズ6: ユーザーダッシュボード

### 作業内容
1. **ユーザー用UI基盤**
   - ユーザーレイアウト
   - ユーザーナビゲーション

2. **ダッシュボード機能**
   - サービスサマリー表示
   - 重要な通知表示
   - クイックアクセスメニュー

3. **サービス詳細管理**
   - 利用中のサービス一覧
   - サービス詳細情報（カテゴリー別表示）
   - サービス機能・特徴表示
   - サービス料金・請求サイクル表示

## フェーズ7: ユーザー向け追加機能

### 作業内容
1. **問い合わせ機能**
   - 問い合わせ型定義の作成（Inquiry型）
   - Firestore関数の実装（CRUD操作、検索、ステータス更新）
   - メール送信機能
     - nodemailerを使用
     - 顧客への受付確認メール
     - 管理者への新規問い合わせ通知メール
   - 顧客向け問い合わせフォーム
     - カテゴリー選択（技術的問題、請求関連、一般的な質問、その他）
     - 件名、本文入力
   - 顧客向け問い合わせ履歴表示
     - 自分の問い合わせ一覧
     - ステータス表示（未回答、回答済み）
   - 管理者向け問い合わせ管理
     - 問い合わせ一覧（フィルター機能付き）
     - ステータス変更機能（未回答/回答済み）
   - 管理者ダッシュボードへの通知
     - 未回答件数の表示
     - 通知バナーの表示

2. **通知システム**
   - アプリ内通知
   - メール通知

## フェーズ8: サービスログ機能の実装

### 作業内容

#### 8.1 データ構造とAPI基盤の整備
1. **データ型定義の拡張**
   - ServiceLog型の定義（types/serviceLog.ts）
   - Service型にlogEnabled: booleanフィールド追加
   - 画像データ関連の型定義

2. **Firestoreコレクション設計**
   - serviceLogsコレクション作成
   - インデックス設計（customerId, serviceId, workDate）
   - セキュリティルール設定（顧客は自分のログのみ閲覧）

3. **Firebase Storage設定**
   - サービスログ画像用ストレージパス設計
   - アップロード権限設定
   - 画像リサイズ機能（Cloud Functions）

4. **データアクセス層実装**
   - lib/firebase/serviceLogs.ts作成
   - CRUD操作関数（作成、取得、更新、削除）
   - 検索・フィルター関数
   - 画像アップロード・削除関数

#### 8.2 管理者向けサービスログ機能
1. **サービス設定画面の拡張**
   - 既存のサービス編集フォームにlogEnabledチェックボックス追加
   - サービス一覧にログ有効/無効の表示

2. **サービスログ管理画面**
   - /admin/service-logs ルート作成
   - ログ一覧表示（ページネーション対応）
   - 検索・フィルター機能
     - 顧客名での検索
     - サービス別フィルター
     - 期間フィルター（日付範囲選択）
     - ステータス別フィルター

3. **ログ登録・編集画面**
   - /admin/service-logs/new, /admin/service-logs/[id]/edit
   - 顧客選択ドロップダウン
   - サービス選択（選択顧客のログ有効サービスのみ）
   - 作業日時選択（DateTimePicker）
   - コメント入力（リッチテキスト対応）
   - 画像アップロード機能
     - カメラ撮影対応
     - ファイル選択対応
     - 複数画像アップロード（最大5枚）
     - 画像プレビュー・削除機能

4. **画像管理機能**
   - 画像圧縮・リサイズ処理
   - WebP形式への変換
   - プログレッシブアップロード
   - 画像メタデータ管理

#### 8.3 顧客向けサービスログ閲覧機能
1. **ナビゲーション拡張**
   - ダッシュボードメニューに「サービスログ」追加

   - モバイルハンバーガーメニューにも追加

2. **サービスログ一覧画面**
   - /dashboard/service-logs ルート作成
   - ビジネス住所利用のサービスを契約していない場合はこの機能は動作しなくてよい
   - 期間フィルター（今月、3ヶ月、6ヶ月、全期間）
   - ログカード形式での一覧表示
   - ページネーション実装
   - 画像表示機能
 

3. **サービスログ詳細画面**
   - /dashboard/service-logs/[id] ルート作成
 
#### 8.4 API エンドポイント実装
1. **REST API設計**
   - POST /api/service-logs - ログ作成
   - GET /api/service-logs - ログ一覧取得（検索・フィルター対応）
   - GET /api/service-logs/[id] - ログ詳細取得
   - PUT /api/service-logs/[id] - ログ更新
   - DELETE /api/service-logs/[id] - ログ削除

2. **画像関連API**
   - POST /api/service-logs/upload-image - 画像アップロード
   - DELETE /api/service-logs/delete-image - 画像削除
   - GET /api/service-logs/images/[id] - 画像取得（サムネイル生成）

3. **権限制御**
   - 管理者：全ログへのアクセス
   - 顧客：自分の契約サービスのログのみ
   - APIレベルでの権限チェック実装

#### 8.5 UI/UXコンポーネント開発
1. **共通コンポーネント**
   - ImageUploader（カメラ・ファイル選択対応）
   - ImageGallery（スライドショー・ズーム機能）
   - DateTimePicker（日本語対応）
   - ServiceSelector（ログ有効サービス絞り込み）

2. **モバイル対応**
   - レスポンシブデザイン対応
   - タッチ操作最適化
   - カメラ撮影のモバイル対応

3. **アクセシビリティ対応**
   - キーボードナビゲーション
   - スクリーンリーダー対応
   - 高コントラストモード対応

#### 8.6 パフォーマンス最適化
1. **画像最適化**
   - 遅延読み込み（Lazy Loading）実装
   - 画像キャッシュ戦略
   - WebP対応とフォールバック

2. **データ最適化**
   - Firestore クエリ最適化
   - インデックス最適化
   - ページネーション実装

3. **キャッシュ戦略**
   - Next.js Image最適化活用
   - SWR/React Queryでのデータキャッシュ

#### 8.7 セキュリティ強化
1. **ファイルアップロード セキュリティ**
   - ファイル形式検証
   - ファイルサイズ制限
   - ウイルスチェック考慮

2. **データ保護**
   - 個人情報の適切な取り扱い
   - GDPR準拠対応
   - データ暗号化

#### 8.8 テスト実装
1. **単体テスト**
   - データアクセス関数のテスト
   - API エンドポイントのテスト
   - コンポーネントのテスト

2. **統合テスト**
   - 画像アップロード機能のテスト
   - 権限制御のテスト
   - エンドツーエンドテスト

## フェーズ9: デプロイ設定とドメイン設定

### 作業内容
1. **Firebase Hosting設定**
   - firebase.jsonの設定
   - Next.js用の設定

2. **Firebase Functions設定**
   - SSR対応の関数作成
   - APIエンドポイント設定

3. **ビルド・デプロイ設定**
   - ビルドスクリプト設定
   - デプロイ自動化

4. **ドメイン設定**
   - members.invento.jpの設定
   - SSL証明書設定

5. **本番環境準備**
   - 環境変数の本番設定
   - セキュリティ設定の最終確認
   - パフォーマンス最適化