# 顧客管理システム要件定義書

## 1. 全体概要

### プロジェクト目的・背景
- 自社用顧客管理システムの構築
- 基本的な管理に加えて、サービスを登録できる
- サービス毎に機能を柔軟に追加できる

### 対象ユーザー
- 管理者
- ユーザー（顧客）

### 想定利用シナリオ・ユースケース

#### 管理者
- 顧客の登録、管理
- サービスの管理

#### ユーザー
- ログイン、パスワードリマインダー
- ユーザーダッシュボード
- 契約内容の確認
- 請求履歴の確認

### システム構成
- 基盤としてFirebaseを採用し、認証・データベース・サーバレス機能を活用する
- ドメインは members.invento.jp とする
- UIはTailwind CSSのフレームワークを使用する
- 開発言語はTypeScriptでNext.jsを採用
- ホスティングはFirebase Hostingを使用

## 2. 顧客管理（管理者向け）

### 機能一覧
- 顧客一覧表示
- 顧客検索機能
- 顧客登録機能（新規、編集、削除）

### 顧客情報項目
- 法人個人種別
- 社名（必須）
- 名前（必須）
- 郵便番号
- 住所-1
- 住所-2
- 転送先郵便番号
- 転送先住所-1
- 転送先住所-2
- 電話番号
- メールアドレス
- 契約開始日
- 契約終了日
- 支払い方法（振込、PayPal）
- 専用電話番号
- 専用電話転送先番号
- 請求書送付有無
- 請求書送付方法（メール、郵送）
- 利用サービス（複数可）

## 3. サービス管理

### サービスカテゴリー機能
- サービスの上位概念としてサービスカテゴリーを定義
- サービスカテゴリーの下に複数のサービスがぶら下がる階層構造
- 顧客は各サービスを複数契約可能

### サービスカテゴリー管理機能
- サービスカテゴリー一覧表示
- サービスカテゴリー検索機能
- サービスカテゴリーの追加、編集、削除

### サービス管理機能
- サービスの追加（カテゴリー選択必須）
- サービスの変更
- サービスの削除
- サービス一覧表示（カテゴリー別表示）
- サービス検索機能

### サービスログ機能

#### 概要
- サービス毎にログ記録の有効/無効を設定可能
- ログ有効なサービスに対して、管理者が作業ログを記録
- 顧客が自分のサービスログを閲覧可能

#### 機能要件

##### 管理者機能
- サービス設定でログ記録フラグの設定
- サービスログの登録・編集・削除
- 全顧客のサービスログ一覧表示
- 顧客別・サービス別でのログ検索・フィルタリング
- ログ画像の撮影・アップロード・管理

##### 顧客機能
- 自分の契約サービスのログ一覧表示
- ログ詳細の閲覧（画像を含む）
- サービス別・期間別でのログフィルタリング

#### データ構造

##### サービス情報（追加項目）
- ログ記録有効フラグ（logEnabled: boolean）

##### サービスログ情報項目
- ログID（自動生成）
- サービスID（必須）
- 顧客ID（必須）
- 作業日時（必須）
- 作業者（管理者ID/名前）
- コメント/作業内容（必須）
- 画像URL（複数可、最大5枚）
- 作成日時
- 更新日時
- ログステータス（下書き、公開）

#### 画面仕様

##### 管理者画面
1. **サービス設定画面**
   - 既存のサービス編集画面にログ有効フラグを追加
   
2. **サービスログ一覧画面**
   - ページング対応の一覧表示
   - 検索・フィルタ機能（顧客名、サービス名、期間）
   - ログ登録ボタン
   
3. **サービスログ登録・編集画面**
   - 顧客選択（ドロップダウン）
   - サービス選択（選択顧客のログ有効サービスのみ）
   - 作業日時選択
   - コメント入力（テキストエリア）
   - 画像アップロード（カメラ/ファイル選択対応）
   - 画像プレビュー機能

##### 顧客画面
1. **サービスログ一覧画面**
   - 自分の契約サービスのログのみ表示
   - サービス別タブ表示
   - 期間フィルタ（今月、3ヶ月、6ヶ月、全期間）
   
2. **サービスログ詳細画面**
   - ログ内容の詳細表示
   - 画像のスライドショー表示
   - 前後のログへのナビゲーション

#### 技術仕様

##### データベース設計
- Firestore Collection: `serviceLogs`
- 画像保存: Firebase Storage
- セキュリティルール: 顧客は自分のログのみ閲覧可能

##### API設計
- `POST /api/service-logs` - ログ作成
- `GET /api/service-logs` - ログ一覧取得
- `PUT /api/service-logs/:id` - ログ更新
- `DELETE /api/service-logs/:id` - ログ削除
- `POST /api/service-logs/upload-image` - 画像アップロード

##### 画像処理
- アップロード時のリサイズ処理
- 画像形式の統一（WebP推奨）
- 最大ファイルサイズ制限（5MB/枚）

#### 非機能要件

##### セキュリティ
- 画像ファイルの検証とサニタイズ
- アップロード時のウイルスチェック考慮
- 顧客データの適切なアクセス制御

##### パフォーマンス
- 画像の遅延読み込み実装
- ログ一覧のページング処理
- 画像キャッシュ戦略

##### 運用
- 画像ストレージの容量管理
- 古いログの自動アーカイブ機能（オプション）

### サービスカテゴリー情報項目
- カテゴリー名（必須）
- カテゴリー説明
- 表示順序
- 有効/無効フラグ

### サービス情報項目（既存に追加）
- 所属カテゴリーID（必須）

## 4. お客様ポータル（ユーザー向けダッシュボード）

### 機能一覧
- ログイン・認証機能（Firebase Auth想定）
- 契約内容確認画面
- 請求・支払い履歴閲覧
- 契約プラン変更申請機能
- 問い合わせフォーム

## 5. 非機能要件

### セキュリティ
- Firebase Authenticationによる認証
- Firestore Security Rulesによるアクセス制御
- HTTPS通信の強制

### パフォーマンス
- ページ読み込み時間: 3秒以内
- 検索レスポンス: 1秒以内

### 可用性
- Firebase Hostingの高可用性を活用
- 99.9%以上の稼働率を目標

### 拡張性
- サービス毎の機能追加を考慮したモジュール設計
- マイクロサービス的なアーキテクチャの採用

## 6. 開発・運用要件

### 開発環境
- Node.js 18以上
- TypeScript 5.0以上
- Next.js 14以上

### 運用環境
- Firebase Hosting
- Firebase Functions（SSR対応）
- Firebase Firestore
- Firebase Authentication

### バックアップ
- Firestoreの自動バックアップ機能を活用
- 日次バックアップの実施

## 更新履歴
- 2025年8月15日: 初版作成